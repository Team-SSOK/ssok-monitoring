apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: logging
data:
  fluentd-opensearch.conf: |
    # Forward input을 통해 Fluent Bit으로부터 로그 수신
    <source>
      @type forward
      port 24224
      bind 0.0.0.0
    </source>

    # 수신된 모든 로그를 OpenSearch로 전송
    <match **>
      @type opensearch
      host opensearch-cluster-master.logging.svc.cluster.local
      port 9200
      scheme http
      index_name fluentd-logs
      logstash_format true
      include_tag_key true
      flush_interval 5s
    
      # 버퍼 설정
      <buffer>
        @type file
        path /var/log/fluentd-buffers/opensearch
        flush_mode interval
        retry_type exponential_backoff
        flush_thread_count 2
        flush_interval 5s
        retry_forever
        retry_max_interval 30
        chunk_limit_size 2M
        queue_limit_length 8
        overflow_action block
      </buffer>
    </match>